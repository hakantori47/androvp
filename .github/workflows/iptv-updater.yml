
name: DeaTHLesS IPTV Updater

on:
  schedule:
    # Her gÃ¼n 6 saatte bir Ã§alÄ±ÅŸ (UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run IPTV Proxy Updater
      id: run-script
      run: |
        python deathless_proxy.py
        
        # Ã‡Ä±ktÄ± dosyasÄ±nÄ± bul
        M3U_FILE=$(ls DeaTHlesS_Proxy_*.m3u | head -1)
        
        if [ -f "$M3U_FILE" ]; then
          # DosyayÄ± ana dizine kopyala
          cp "$M3U_FILE" deathless_proxy_latest.m3u
          
          # Kanal sayÄ±sÄ±nÄ± al
          CHANNEL_COUNT=$(grep -c '#EXTINF' deathless_proxy_latest.m3u)
          
          echo "channel_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          echo "file_name=deathless_proxy_latest.m3u" >> $GITHUB_OUTPUT
          echo "m3u_file=deathless_proxy_latest.m3u" >> $GITHUB_OUTPUT
        fi
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push if changed
      run: |
        git add deathless_proxy_latest.m3u
        git diff --cached --quiet || git commit -m "ðŸ“º Update IPTV list (${{ steps.run-script.outputs.channel_count }} channels) [skip ci]"
        git push origin main
    
    - name: Create summary
      run: |
        echo "## ðŸŽ¯ IPTV Update Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Successfully updated IPTV list!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Channels:** ${{ steps.run-script.outputs.channel_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **File:** [${{ steps.run-script.outputs.m3u_file }}](https://raw.githubusercontent.com/${{ github.repository }}/main/${{ steps.run-script.outputs.m3u_file }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **Last Update:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Direct M3U Link:**" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        echo "https://raw.githubusercontent.com/${{ github.repository }}/main/deathless_proxy_latest.m3u" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload M3U file as artifact
      uses: actions/upload-artifact@v3
      with:
        name: iptv-playlist
        path: deathless_proxy_latest.m3u
