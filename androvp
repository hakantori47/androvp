import requests
import os
import json
import time
import concurrent.futures
from urllib.parse import quote

def test_proxy_speed(proxy_url, test_url="https://httpbin.org/ip", timeout=3):
    """Proxy hÄ±zÄ±nÄ± test et"""
    try:
        start_time = time.time()
        response = requests.get(test_url, timeout=timeout, 
                              proxies={"http": proxy_url, "https": proxy_url})
        if response.status_code == 200:
            speed = time.time() - start_time
            return proxy_url, speed, True
    except:
        pass
    return proxy_url, 10, False  # YÃ¼ksek sÃ¼re = yavaÅŸ

def get_fastest_proxies():
    """HÄ±zlÄ± proxy'leri bul"""
    print("âš¡ En hÄ±zlÄ± proxy'ler aranÄ±yor...")
    
    proxy_list = [
        # TÃ¼rk proxy'leri (daha hÄ±zlÄ±)
        "http://proxy1.wifispeed.org:8080",
        "http://proxy2.wifispeed.org:8080",
        "http://proxy.tr:8080",
        "http://185.199.229.156:7492",
        "http://185.199.228.220:7300",
        "http://185.199.231.45:8382",
        
        # Cloudflare Workers (CORS bypass)
        "https://corsproxy.io/?",
        "https://api.codetabs.com/v1/proxy?quest=",
        "https://proxy.ponelat.workers.dev/",
        "https://cors.gerhut.workers.dev/?",
        
        # Public proxy'ler
        "http://45.77.56.113:3128",
        "http://138.197.157.32:3128",
        "http://167.71.5.83:3128",
        "http://68.183.221.156:3128",
        
        # Free proxy pool
        "http://20.210.113.32:80",
        "http://20.206.106.192:80",
        "http://20.24.43.214:8123",
        "http://103.152.112.145:80",
        
        # TÃ¼rkiye proxy'leri (yeni)
        "http://88.255.102.10:8080",
        "http://176.235.99.12:9090",
        "http://85.105.25.165:8080",
        "http://212.252.126.54:8080",
        "http://95.0.219.201:8080",
    ]
    
    # Workers proxy'leri (Ã¶zel format)
    workers = [
        ("CF-Proxy", "https://withered-shape-3305.vadimkantorov.workers.dev/?"),
        ("Rapid-Proxy", "https://rapid-wave-c8e3.redfor14314.workers.dev/"),
        ("Cors-Free", "https://proxy.freecdn.workers.dev/?url="),
        ("Hello-World", "https://hello-world-aged-resonance-fc8f.bokaflix.workers.dev/?apiUrl="),
    ]
    
    fast_proxies = []
    
    # Test et (paralel)
    with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
        futures = []
        for proxy in proxy_list:
            futures.append(executor.submit(test_proxy_speed, proxy))
        
        for future in concurrent.futures.as_completed(futures):
            proxy, speed, working = future.result()
            if working and speed < 2:  # 2 saniyeden hÄ±zlÄ± olanlar
                fast_proxies.append((proxy, speed))
                print(f"   âœ… {proxy.split('//')[-1].split(':')[0]} - {speed:.2f}s")
    
    # Workers'larÄ± ekle (genelde Ã§alÄ±ÅŸÄ±yor)
    for name, url in workers:
        fast_proxies.append((url, 0.5))
        print(f"   âœ… {name} - 0.50s (Worker)")
    
    # HÄ±zÄ±na gÃ¶re sÄ±rala
    fast_proxies.sort(key=lambda x: x[1])
    
    print(f"ğŸ“Š {len(fast_proxies)} hÄ±zlÄ± proxy bulundu")
    return [p[0] for p in fast_proxies[:10]]  # Ä°lk 10'u al

def check_url_with_proxy(url, proxies, timeout=5):
    """URL'i proxy ile kontrol et"""
    # Ã–nce doÄŸrudan dene
    try:
        response = requests.head(url, timeout=timeout)
        if response.status_code == 200:
            return url, "direct"
    except:
        pass
    
    # Proxy'lerle dene
    for proxy in proxies:
        try:
            if proxy.endswith("?") or "?url=" in proxy or "?quest=" in proxy or "apiUrl=" in proxy:
                # Worker proxy formatÄ±
                proxy_url = f"{proxy}{url}"
            elif proxy.startswith("http://") or proxy.startswith("https://"):
                # Normal proxy formatÄ±
                proxy_url = url
                proxies_dict = {"http": proxy, "https": proxy}
                response = requests.head(proxy_url, timeout=timeout, proxies=proxies_dict)
                if response.status_code == 200:
                    return proxy_url, proxy
                continue
            else:
                continue
                
            response = requests.head(proxy_url, timeout=timeout)
            if response.status_code == 200:
                return proxy_url, proxy.split("//")[-1].split("/")[0]
        except:
            continue
    
    return None, None

def get_DeaTHLesS_streams():
    """DeaTHLesS IPTV stream'lerini al (VPN gerektirmeden)"""
    
    print("=" * 60)
    print("ğŸš€ DeaTHLesS IPTV Bot - Proxy Modu")
    print("=" * 60)
    
    # 1. HÄ±zlÄ± proxy'leri bul
    fast_proxies = get_fastest_proxies()
    
    if not fast_proxies:
        print("âŒ Ã‡alÄ±ÅŸan proxy bulunamadÄ±!")
        return ""
    
    # 2. Aktif domain ara
    print("\nğŸ” Aktif domain aranÄ±yor...")
    
    domains_to_try = [
        "https://andro.226503.xyz/checklist/",
        "https://androiptv.fun/checklist/",
        "https://birazcikspor.xyz/checklist/",
        "https://birazcikspor42.xyz/checklist/",
        "https://birazcikspor43.xyz/checklist/",
        "https://androstream.live/checklist/",
        "https://deathlessiptv.com/checklist/",
    ]
    
    # Domain keÅŸfi
    for i in range(1, 50):
        domains_to_try.append(f"https://birazcikspor{i}.xyz/checklist/")
    
    active_base = None
    
    for domain in domains_to_try:
        for proxy in fast_proxies:
            try:
                if proxy.endswith("?") or "?url=" in proxy:
                    test_url = f"{proxy}{domain}androstreamlivebs1.m3u8"
                else:
                    test_url = f"{domain}androstreamlivebs1.m3u8"
                
                response = requests.head(test_url, timeout=3)
                if response.status_code == 200:
                    active_base = domain
                    print(f"âœ… Aktif domain: {domain}")
                    break
            except:
                continue
        if active_base:
            break
    
    if not active_base:
        # Son Ã§are: bilinen domain
        active_base = "https://andro.226503.xyz/checklist/"
        print(f"âš   VarsayÄ±lan domain kullanÄ±lÄ±yor: {active_base}")
    
    # 3. Kanal listesini oluÅŸtur
    print(f"\nğŸ“¡ Kanal listesi oluÅŸturuluyor...")
    
    m3u_content = create_m3u_with_proxies(active_base, fast_proxies)
    
    return m3u_content

def create_m3u_with_proxies(base_url, proxies):
    """Proxy'lerle M3U iÃ§eriÄŸi oluÅŸtur"""
    m3u_content = ""
    
    # Kanal listesi
    channels = [
        # beIN Sports
        ["beIN Sport 1 HD", "androstreamlivebs1"],
        ["beIN Sport 2 HD", "androstreamlivebs2"],
        ["beIN Sport 3 HD", "androstreamlivebs3"],
        ["beIN Sport 4 HD", "androstreamlivebs4"],
        ["beIN Sport 5 HD", "androstreamlivebs5"],
        ["beIN Sport Max 1 HD", "androstreamlivebsm1"],
        ["beIN Sport Max 2 HD", "androstreamlivebsm2"],
        
        # S Sport
        ["S Sport 1 HD", "androstreamlivess1"],
        ["S Sport 2 HD", "androstreamlivess2"],
        ["S Sport 3 HD", "androstreamlivess3"],
        ["S Sport 4 HD", "androstreamlivess4"],
        
        # Tivibu Sport
        ["Tivibu Sport HD", "androstreamlivets"],
        ["Tivibu Sport 1 HD", "androstreamlivets1"],
        ["Tivibu Sport 2 HD", "androstreamlivets2"],
        ["Tivibu Sport 3 HD", "androstreamlivets3"],
        ["Tivibu Sport 4 HD", "androstreamlivets4"],
        
        # Smart Sport
        ["Smart Sport 1 HD", "androstreamlivesm1"],
        ["Smart Sport 2 HD", "androstreamlivesm2"],
        ["Smart Sport 3 HD", "androstreamlivesm3"],
        
        # Euro Sport
        ["Euro Sport 1 HD", "androstreamlivees1"],
        ["Euro Sport 2 HD", "androstreamlivees2"],
        
        # Tabii
        ["Tabii HD", "androstreamlivetb"],
        ["Tabii 1 HD", "androstreamlivetb1"],
        ["Tabii 2 HD", "androstreamlivetb2"],
        ["Tabii 3 HD", "androstreamlivetb3"],
        ["Tabii 4 HD", "androstreamlivetb4"],
        ["Tabii 5 HD", "androstreamlivetb5"],
        
        # Exxen
        ["Exxen HD", "androstreamliveexn"],
        ["Exxen 1 HD", "androstreamliveexn1"],
        ["Exxen 2 HD", "androstreamliveexn2"],
        ["Exxen 3 HD", "androstreamliveexn3"],
        ["Exxen 4 HD", "androstreamliveexn4"],
        ["Exxen 5 HD", "androstreamliveexn5"],
        
        # Facebook Streams
        ["Facebook beIN Sport 1", "facebooklivebs1"],
        ["Facebook beIN Sport 2", "facebooklivebs2"],
        ["Facebook S Sport 1", "facebooklivess1"],
        ["Facebook Tivibu Sport", "facebooklivets"],
    ]
    
    successful_channels = []
    logo_url = "https://i.hizliresim.com/8xzjgqv.jpg"
    
    print(f"ğŸ“Š {len(channels)} kanal test ediliyor...")
    print("-" * 40)
    
    # Paralel kanal kontrolÃ¼
    def check_channel(channel):
        name, channel_id = channel
        url = f"{base_url}{channel_id}.m3u8"
        
        stream_url, used_proxy = check_url_with_proxy(url, proxies)
        
        if stream_url:
            extinf = f'#EXTINF:-1 tvg-id="sport.tr" tvg-name="TR:{name}" tvg-logo="{logo_url}" group-title="TURKIYE DEATHLESS",TR:{name}\n'
            return name, extinf + stream_url + "\n", True
        return name, "", False
    
    # Thread pool ile hÄ±zlÄ± kontrol
    with concurrent.futures.ThreadPoolExecutor(max_workers=20) as executor:
        future_to_channel = {executor.submit(check_channel, channel): channel for channel in channels}
        
        for future in concurrent.futures.as_completed(future_to_channel):
            channel_name, content, success = future.result()
            if success:
                m3u_content += content
                successful_channels.append(channel_name)
                print(f"âœ… {channel_name}")
            else:
                print(f"âŒ {channel_name}")
    
    print("-" * 40)
    print(f"ğŸ“Š BaÅŸarÄ±lÄ±: {len(successful_channels)}/{len(channels)} kanal")
    
    # 4. Ek kanallarÄ± keÅŸfet
    if successful_channels:
        print("\nğŸ” Ek kanallar taranÄ±yor...")
        additional = discover_additional_channels_parallel(base_url, proxies, logo_url)
        if additional:
            m3u_content += additional
            added_count = additional.count('#EXTINF')
            print(f"â• {added_count} ek kanal bulundu")
            successful_channels.append(f"+{added_count} ek kanal")
    
    # 5. Proxy bilgilerini ekle (yorum olarak)
    m3u_content = f"#EXTM3U\n# Generated with Proxy Mode\n# Proxies used: {len(proxies)}\n" + m3u_content
    
    return m3u_content

def discover_additional_channels_parallel(base_url, proxies, logo_url):
    """Paralel ek kanal keÅŸfi"""
    additional_content = ""
    
    # Test edilecek pattern'ler
    patterns_to_test = []
    
    # beIN Sports (1-10)
    for i in range(1, 11):
        patterns_to_test.append(f"androstreamlivebs{i}")
    
    # S Sport (1-5)
    for i in range(1, 6):
        patterns_to_test.append(f"androstreamlivess{i}")
    
    # Tivibu Sport (1-6)
    for i in range(1, 7):
        patterns_to_test.append(f"androstreamlivets{i}")
    
    # Tabii (1-10)
    for i in range(1, 11):
        patterns_to_test.append(f"androstreamlivetb{i}")
    
    # Exxen (1-10)
    for i in range(1, 11):
        patterns_to_test.append(f"androstreamliveexn{i}")
    
    # Facebook
    for i in range(1, 6):
        patterns_to_test.append(f"facebooklivebs{i}")
        patterns_to_test.append(f"facebooklivess{i}")
    
    discovered = []
    
    def test_pattern(pattern):
        url = f"{base_url}{pattern}.m3u8"
        stream_url, _ = check_url_with_proxy(url, proxies, timeout=3)
        return pattern, stream_url
    
    # Paralel test
    with concurrent.futures.ThreadPoolExecutor(max_workers=15) as executor:
        futures = {executor.submit(test_pattern, pattern): pattern for pattern in patterns_to_test}
        
        for future in concurrent.futures.as_completed(futures):
            pattern, stream_url = future.result()
            if stream_url:
                channel_name = pattern.replace("androstreamlive", "").replace("facebooklive", "Facebook ")
                additional_content += f'#EXTINF:-1 tvg-id="sport.tr" tvg-name="TR:{channel_name}" tvg-logo="{logo_url}" group-title="TURKIYE DEATHLESS",TR:{channel_name}\n'
                additional_content += f"{stream_url}\n"
                discovered.append(pattern)
    
    if discovered:
        print(f"   ğŸ¯ {len(discovered)} yeni kanal keÅŸfedildi")
    
    return additional_content

def save_m3u_file(content, output_dir="output"):
    """M3U dosyasÄ±nÄ± kaydet"""
    try:
        os.makedirs(output_dir, exist_ok=True)
        
        # Tarihli dosya adÄ±
        from datetime import datetime
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        file_name = f"DeaTHlesS_Proxy_{timestamp}.m3u"
        file_path = os.path.join(output_dir, file_name)
        
        with open(file_path, "w", encoding="utf-8") as f:
            f.write(content)
        
        # Kanal sayÄ±sÄ±nÄ± hesapla
        channel_count = content.count('#EXTINF')
        
        print("\n" + "=" * 60)
        print("âœ… Ä°ÅLEM TAMAMLANDI!")
        print("=" * 60)
        print(f"ğŸ“‚ Dosya: {file_path}")
        print(f"ğŸ“Š Toplam Kanal: {channel_count}")
        print(f"ğŸ’¾ Boyut: {os.path.getsize(file_path)} bytes")
        
        # Ä°lk 3 kanalÄ± gÃ¶ster
        print("\nğŸ“º Ã–rnek Kanallar:")
        lines = content.split('\n')
        count = 0
        for line in lines:
            if line.startswith('#EXTINF') and count < 3:
                name = line.split(',')[-1] if ',' in line else line
                print(f"   â€¢ {name}")
                count += 1
        
        # Proxy bilgisi
        proxy_lines = [line for line in lines if line.startswith('#') and 'Proxy' in line]
        if proxy_lines:
            print(f"\nğŸ”— {proxy_lines[0]}")
        
        return file_path
        
    except Exception as e:
        print(f"âŒ Dosya kaydetme hatasÄ±: {e}")
        return None

if __name__ == "__main__":
    try:
        # VPN olmadan Ã§alÄ±ÅŸacak proxy modu
        m3u_data = get_DeaTHLesS_streams()
        
        if m3u_data and m3u_data.count('#EXTINF') > 0:
            saved_file = save_m3u_file(m3u_data, output_dir=".")
            
            # GitHub Actions iÃ§in Ã¶zel Ã§Ä±ktÄ±
            print("\nğŸš€ GITHUB ACTIONS: Proxy modu baÅŸarÄ±yla Ã§alÄ±ÅŸtÄ±!")
            print("ğŸ“¤ M3U dosyasÄ± otomatik olarak commit edilecek.")
            
        else:
            print("\nâš   UYARI: Yeterli kanal bulunamadÄ±!")
            print("ğŸ’¡ Ä°pucu: Daha fazla proxy eklemeyi deneyin veya internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.")
            
        exit(0)
        
    except KeyboardInterrupt:
        print("\n\nâ¹  Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan durduruldu.")
        exit(1)
    except Exception as e:
        print(f"\nâŒ Beklenmeyen hata: {e}")
        exit(1)
